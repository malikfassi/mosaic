name: Notify Status

on:
  workflow_call:
    inputs:
      execution_plan:
        required: true
        type: string
      frontend_ci_result:
        required: true
        type: string
      mosaic_tile_ci_result:
        required: true
        type: string
      mosaic_vending_ci_result:
        required: true
        type: string
      mosaic_tile_deploy_result:
        required: true
        type: string
      mosaic_vending_deploy_result:
        required: true
        type: string
      mosaic_tile_e2e_result:
        required: true
        type: string
      mosaic_vending_e2e_result:
        required: true
        type: string
      full_e2e_result:
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK:
        required: true
      GIST_TOKEN:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate Status Message
        id: status
        run: |
          # Parse execution plan
          plan='${{ inputs.execution_plan }}'
          
          # Function to format job link
          format_job_link() {
            local job_name=$1
            local job_id=$2
            echo "[#$job_id](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs/$job_id)"
          }
          
          # Function to format job result
          format_job_result() {
            local job_name=$1
            local current_result=$2
            
            # Get job info from execution plan
            local job=$(echo "$plan" | jq -r ".jobs[\"$job_name\"]")
            local needs_run=$(echo "$job" | jq -r '.needs_run')
            local previous_result=$(echo "$job" | jq -r '.previous_result')
            local previous_deps=$(echo "$job" | jq -r '.previous_dependency_results')
            
            # Format current result
            local result_emoji
            case "$current_result" in
              "success") result_emoji="‚úÖ";;
              "failure") result_emoji="‚ùå";;
              "cancelled") result_emoji="‚ö™";;
              "skipped") result_emoji="‚è≠Ô∏è";;
              *) result_emoji="‚ùì";;
            esac
            
            # Add previous result info if available
            local result_text="$result_emoji"
            if [[ "$needs_run" == "false" && "$previous_result" != "null" ]]; then
              # Get previous run info
              local component_name=$(echo "$job" | jq -r '.component')
              if [[ "$component_name" != "null" ]]; then
                local previous_run=$(echo "$plan" | jq -r ".components.$component_name.previous_run.run")
                if [[ "$previous_run" != "null" ]]; then
                  local run_url=$(echo "$previous_run" | jq -r '.url')
                  local run_date=$(echo "$previous_run" | jq -r '.created_at' | cut -d'T' -f1)
                  result_text+=" (reusing $run_date [run]($run_url))"
                fi
              fi
            fi
            
            # Add dependency results if any failed
            if [[ "$previous_deps" != "{}" ]]; then
              local failed_deps=$(echo "$previous_deps" | jq -r 'to_entries | map(select(.value != "success")) | map(.key) | join(", ")')
              if [[ -n "$failed_deps" ]]; then
                result_text+="\n‚ö†Ô∏è Previous run had failed dependencies: $failed_deps"
              fi
            fi
            
            echo "$result_text"
          }
          
          # Create message
          message="# üöÄ Workflow Run Report

\`$(echo "$plan" | jq -r '.metadata.commit_sha')\` ‚Ä¢ $(echo "$plan" | jq -r '.metadata.event_type') ‚Ä¢ \`main\` ‚Ä¢ [View Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
$(if [[ "${{ inputs.frontend_ci_result }}" == "success" && "${{ inputs.mosaic_tile_ci_result }}" == "success" && "${{ inputs.mosaic_vending_ci_result }}" == "success" && "${{ inputs.full_e2e_result }}" == "success" ]]; then echo "‚úÖ"; else echo "‚ùå"; fi) Overall Status

## üîç Components

### üé® Frontend (\`$(echo "$plan" | jq -r '.components.frontend.hash')\`)
$(if [[ "$(echo "$plan" | jq -r '.components.frontend.files_changed')" == "true" ]]; then
  echo "üìù Changes:"
  echo "$plan" | jq -r '.components.frontend.changed_files | map("- " + .) | join("\n")'
else
  previous_run=$(echo "$plan" | jq -r '.components.frontend.previous_run')
  if [[ "$(echo "$previous_run" | jq -r '.found')" == "true" ]]; then
    echo "‚ú® No changes _(using $(echo "$previous_run.run" | jq -r '.created_at' | cut -d'T' -f1) [run]($(echo "$previous_run.run" | jq -r '.url')))_"
  else
    echo "üÜï First run"
  fi
fi)

**Pipeline:** $(if [[ "$(echo "$plan" | jq -r '.jobs.frontend-ci.needs_run')" == "false" ]]; then
  echo "‚úÖ CI _(reused)_"
else
  echo "CI: $(format_job_result "frontend-ci" "${{ inputs.frontend_ci_result }}")"
fi)

### üß© Mosaic Tile (\`$(echo "$plan" | jq -r '.components.mosaic_tile.hash')\`)
$(if [[ "$(echo "$plan" | jq -r '.components.mosaic_tile.files_changed')" == "true" ]]; then
  echo "üìù Changes:"
  echo "$plan" | jq -r '.components.mosaic_tile.changed_files | map("- " + .) | join("\n")'
else
  previous_run=$(echo "$plan" | jq -r '.components.mosaic_tile.previous_run')
  if [[ "$(echo "$previous_run" | jq -r '.found')" == "true" ]]; then
    echo "‚ú® No changes _(using $(echo "$previous_run.run" | jq -r '.created_at' | cut -d'T' -f1) [run]($(echo "$previous_run.run" | jq -r '.url')))_"
  else
    echo "üÜï First run"
  fi
fi)

**Pipeline:** $(if [[ "$(echo "$plan" | jq -r '.jobs.mosaic-tile-ci.needs_run')" == "false" ]]; then
  echo "‚úÖ CI _(reused)_ ‚Üí "
else
  echo "CI: $(format_job_result "mosaic-tile-ci" "${{ inputs.mosaic_tile_ci_result }}") ‚Üí "
fi)$(if [[ "$(echo "$plan" | jq -r '.jobs.deploy-mosaic-tile.needs_run')" == "false" ]]; then
  echo "‚úÖ Deploy _(reused)_ ‚Üí "
else
  echo "Deploy: $(format_job_result "deploy-mosaic-tile" "${{ inputs.mosaic_tile_deploy_result }}") ‚Üí "
fi)$(if [[ "$(echo "$plan" | jq -r '.jobs.mosaic-tile-e2e.needs_run')" == "false" ]]; then
  echo "‚úÖ E2E _(reused)_"
else
  echo "E2E: $(format_job_result "mosaic-tile-e2e" "${{ inputs.mosaic_tile_e2e_result }}")"
fi)

### üé≤ Mosaic Vending (\`$(echo "$plan" | jq -r '.components.mosaic_vending.hash')\`)
$(if [[ "$(echo "$plan" | jq -r '.components.mosaic_vending.files_changed')" == "true" ]]; then
  echo "üìù Changes:"
  echo "$plan" | jq -r '.components.mosaic_vending.changed_files | map("- " + .) | join("\n")'
else
  previous_run=$(echo "$plan" | jq -r '.components.mosaic_vending.previous_run')
  if [[ "$(echo "$previous_run" | jq -r '.found')" == "true" ]]; then
    echo "‚ú® No changes _(using $(echo "$previous_run.run" | jq -r '.created_at' | cut -d'T' -f1) [run]($(echo "$previous_run.run" | jq -r '.url')))_"
  else
    echo "üÜï First run"
  fi
fi)

**Pipeline:** $(if [[ "$(echo "$plan" | jq -r '.jobs.mosaic-vending-ci.needs_run')" == "false" ]]; then
  echo "‚úÖ CI _(reused)_ ‚Üí "
else
  echo "CI: $(format_job_result "mosaic-vending-ci" "${{ inputs.mosaic_vending_ci_result }}") ‚Üí "
fi)$(if [[ "$(echo "$plan" | jq -r '.jobs.deploy-mosaic-vending.needs_run')" == "false" ]]; then
  echo "‚úÖ Deploy _(reused)_ ‚Üí "
else
  echo "Deploy: $(format_job_result "deploy-mosaic-vending" "${{ inputs.mosaic_vending_deploy_result }}") ‚Üí "
fi)$(if [[ "$(echo "$plan" | jq -r '.jobs.mosaic-vending-e2e.needs_run')" == "false" ]]; then
  echo "‚úÖ E2E _(reused)_"
else
  echo "E2E: $(format_job_result "mosaic-vending-e2e" "${{ inputs.mosaic_vending_e2e_result }}")"
fi)

### üîÑ Integration
**Full E2E:** $(if [[ "$(echo "$plan" | jq -r '.jobs.full-e2e.needs_run')" == "false" ]]; then
  echo "‚úÖ _(no changes)_"
else
  echo "$(format_job_result "full-e2e" "${{ inputs.full_e2e_result }}")"
fi)

## üìã Execution Plan
\`\`\`json
$plan
\`\`\`"
          
          # Save message
          {
            echo "message<<EOF"
            echo "$message"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        if: always()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: ${{ steps.status.outputs.message }}

      - name: Create status file
        run: |
          echo "${{ steps.status.outputs.message }}" > status.md

      - name: Update Status Gist
        if: always()
        uses: fjogeleit/http-request-action@v1
        with:
          url: https://api.github.com/gists/${{ inputs.gist_id }}
          method: 'PATCH'
          bearerToken: ${{ secrets.GIST_TOKEN }}
          data: |
            {
              "files": {
                "status.md": {
                  "content": "${{ steps.status.outputs.message }}"
                }
              }
            }