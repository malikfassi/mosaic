name: Notifications

on:
  workflow_call:
    inputs:
      frontend_ci_result:
        required: true
        type: string
      mosaic_tile_ci_result:
        required: true
        type: string
      mosaic_vending_ci_result:
        required: true
        type: string
      mosaic_tile_e2e_result:
        required: true
        type: string
      mosaic_vending_e2e_result:
        required: true
        type: string
      full_e2e_result:
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK:
        required: true
      GIST_TOKEN:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Needed to get all history

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          GH_TOKEN: ${{ github.token }}
        run: |
          # Function to get status emoji
          get_status_emoji() {
            case "$1" in
              "success") echo "‚úÖ";;
              "failure") echo "‚ùå";;
              "cancelled") echo "‚ö†Ô∏è";;
              "skipped") echo "‚è≠Ô∏è";;
              *) echo "‚ùì";;
            esac
          }

          # Function to get run status message
          get_run_status() {
            local job_name=$1
            local result=$2
            local component=$3
            
            if [[ "$result" == "skipped" ]]; then
              # Find last successful run
              local last_success_run=$(gh run list --workflow pixel-canvas.yml \
                --json conclusion,jobs,databaseId,url \
                --jq ".[] | select(.conclusion == \"success\" and .jobs[].name == \"$job_name\") | {id: .databaseId, url: .url}" \
                --limit 100 | head -n 1)
              
              if [[ -n "$last_success_run" ]]; then
                local run_url=$(echo "$last_success_run" | jq -r '.url')
                echo "‚è≠Ô∏è \`skipped\` ([previous run]($run_url))"
              else
                echo "‚è≠Ô∏è \`skipped\`"
              fi
            else
              echo "$(get_status_emoji "$result") \`$result\`"
            fi
          }

          # Overall status
          overall_status="success"
          for result in "${{ inputs.frontend_ci_result }}" "${{ inputs.mosaic_tile_ci_result }}" "${{ inputs.mosaic_vending_ci_result }}" "${{ inputs.mosaic_tile_e2e_result }}" "${{ inputs.mosaic_vending_e2e_result }}" "${{ inputs.full_e2e_result }}"; do
            if [[ "$result" == "failure" ]]; then
              overall_status="failure"
              break
            fi
          done

          # Build notification message
          message=$(cat << EOF
          **üöÄ Workflow Run: $([ "$overall_status" == "success" ] && echo "‚úÖ Success" || echo "‚ùå Failed")**

          **üî® Build & Test**
          ‚Ä¢ Frontend CI: $(get_run_status "frontend-ci" "${{ inputs.frontend_ci_result }}" "frontend")
          ‚Ä¢ Mosaic Tile CI: $(get_run_status "mosaic-tile-ci" "${{ inputs.mosaic_tile_ci_result }}" "mosaic_tile")
          ‚Ä¢ Mosaic Vending CI: $(get_run_status "mosaic-vending-ci" "${{ inputs.mosaic_vending_ci_result }}" "mosaic_vending")

          **üß™ E2E Tests**
          ‚Ä¢ Mosaic Tile: $(get_run_status "mosaic-tile-e2e" "${{ inputs.mosaic_tile_e2e_result }}" "mosaic_tile")
          ‚Ä¢ Mosaic Vending: $(get_run_status "mosaic-vending-e2e" "${{ inputs.mosaic_vending_e2e_result }}" "mosaic_vending")
          ‚Ä¢ Full E2E: $(get_run_status "full-e2e" "${{ inputs.full_e2e_result }}" "full")

          **üîó Links**
          ‚Ä¢ [View Run Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          ‚Ä¢ [View Changes](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          EOF
          )

          # Escape the message for JSON
          message_escaped=$(echo "$message" | jq -R -s '.')

          # Send to Discord
          json_data=$(cat << EOF
          {
            "username": "GitHub Actions",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "üöÄ Workflow Run",
              "description": ${message_escaped},
              "color": $([ "$overall_status" == "success" ] && echo "5025616" || echo "15158332")
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" -X POST -d "$json_data" $DISCORD_WEBHOOK 