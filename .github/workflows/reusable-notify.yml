---
name: Notify Status

on:
  workflow_call:
    inputs:
      execution_plan:
        required: true
        type: string
      frontend_ci_result:
        required: true
        type: string
      mosaic_tile_ci_result:
        required: true
        type: string
      mosaic_vending_ci_result:
        required: true
        type: string
      mosaic_tile_deploy_result:
        required: true
        type: string
      mosaic_vending_deploy_result:
        required: true
        type: string
      mosaic_tile_e2e_result:
        required: true
        type: string
      mosaic_vending_e2e_result:
        required: true
        type: string
      full_e2e_result:
        required: true
        type: string
      gist_id:
        required: true
        type: string
    secrets:
      DISCORD_WEBHOOK:
        required: true
      GIST_TOKEN:
        required: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: .github/workflow-scripts/package.json

      - name: Install dependencies
        working-directory: .github/workflow-scripts
        run: npm ci

      - name: Generate notification
        id: notify
        working-directory: .github/workflow-scripts
        env:
          EXECUTION_PLAN: ${{ inputs.execution_plan }}
          FRONTEND_CI_RESULT: ${{ inputs.frontend_ci_result }}
          MOSAIC_TILE_CI_RESULT: ${{ inputs.mosaic_tile_ci_result }}
          MOSAIC_VENDING_CI_RESULT: ${{ inputs.mosaic_vending_ci_result }}
          MOSAIC_TILE_DEPLOY_RESULT: ${{ inputs.mosaic_tile_deploy_result }}
          MOSAIC_VENDING_DEPLOY_RESULT: ${{ inputs.mosaic_vending_deploy_result }}
          MOSAIC_TILE_E2E_RESULT: ${{ inputs.mosaic_tile_e2e_result }}
          MOSAIC_VENDING_E2E_RESULT: ${{ inputs.mosaic_vending_e2e_result }}
          FULL_E2E_RESULT: ${{ inputs.full_e2e_result }}
        run: npm run notify

      - name: Send Discord notification
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          filename: discord_message.txt

      - name: Update status gist
        uses: ./.github/workflows/reusable-status.yml
        with:
          action: update
          execution_plan: ${{ inputs.execution_plan }}
          gist_id: ${{ inputs.gist_id }}
        secrets:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}