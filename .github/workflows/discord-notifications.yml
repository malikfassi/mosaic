name: Discord Notifications

on:
  workflow_run:
    workflows:
      - "Frontend"
      - "Contracts"
    types:
      - completed

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get workflow details
        id: workflow
        run: |
          # Get workflow info
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_STATUS="${{ github.event.workflow_run.conclusion }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          COMMIT_MSG=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "${{ github.event.workflow_run.head_repository.url }}/git/commits/${{ github.event.workflow_run.head_sha }}" \
            | jq -r '.message' | head -n 1)
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          
          # Set emoji based on status
          if [ "$WORKFLOW_STATUS" = "success" ]; then
            STATUS_EMOJI="✅"
            COLOR="3066993"  # Green
          elif [ "$WORKFLOW_STATUS" = "failure" ]; then
            STATUS_EMOJI="❌"
            COLOR="15158332"  # Red
          else
            STATUS_EMOJI="⚠️"
            COLOR="16776960"  # Yellow
          fi
          
          # Export variables
          echo "name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "status=$WORKFLOW_STATUS" >> $GITHUB_OUTPUT
          echo "emoji=$STATUS_EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "commit_sha=${COMMIT_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "actor=$ACTOR" >> $GITHUB_OUTPUT
          echo "duration=$((${{ github.event.workflow_run.updated_at }} - ${{ github.event.workflow_run.run_started_at }}))" >> $GITHUB_OUTPUT

      - name: Send notification
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "embeds": [{
                "title": "${{ steps.workflow.outputs.emoji }} ${{ steps.workflow.outputs.name }} Workflow",
                "description": "**Status:** \`${{ steps.workflow.outputs.status }}\`\n**Duration:** \`${{ steps.workflow.outputs.duration }}s\`",
                "color": ${{ steps.workflow.outputs.color }},
                "fields": [
                  {
                    "name": "Triggered By",
                    "value": "\`${{ steps.workflow.outputs.actor }}\`",
                    "inline": true
                  },
                  {
                    "name": "Branch",
                    "value": "\`${{ steps.workflow.outputs.branch }}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${{ steps.workflow.outputs.commit_sha }}\` - ${{ steps.workflow.outputs.commit_msg }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Pixel Canvas CI/CD"
                },
                "timestamp": "${{ github.event.workflow_run.updated_at }}"
              }]
            }

      - name: Send deployment notification
        if: |
          github.event.workflow_run.name == 'Contracts' && 
          contains(github.event.workflow_run.head_commit.message, 'deploy') &&
          github.event.workflow_run.conclusion == 'success'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "embeds": [{
                "title": "🚀 Contract Deployment",
                "description": "New contract deployment completed successfully",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Environment",
                    "value": "\`${{ github.event.workflow_run.environment }}\`",
                    "inline": true
                  },
                  {
                    "name": "Deployed By",
                    "value": "\`${{ steps.workflow.outputs.actor }}\`",
                    "inline": true
                  },
                  {
                    "name": "Commit",
                    "value": "\`${{ steps.workflow.outputs.commit_sha }}\` - ${{ steps.workflow.outputs.commit_msg }}",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "Pixel Canvas Deployments"
                },
                "timestamp": "${{ github.event.workflow_run.updated_at }}"
              }]
            }

      - name: Send test report
        if: |
          github.event.workflow_run.conclusion == 'success' &&
          (contains(github.event.workflow_run.head_commit.message, 'test') ||
           contains(github.event.workflow_run.name, 'E2E'))
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            {
              "embeds": [{
                "title": "📊 Test Results",
                "description": "Test suite completed successfully",
                "color": 3066993,
                "fields": [
                  {
                    "name": "Type",
                    "value": "${{ github.event.workflow_run.name == 'Frontend' && 'Frontend E2E' || 'Contract E2E' }}",
                    "inline": true
                  },
                  {
                    "name": "Duration",
                    "value": "\`${{ steps.workflow.outputs.duration }}s\`",
                    "inline": true
                  },
                  {
                    "name": "Run By",
                    "value": "\`${{ steps.workflow.outputs.actor }}\`",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Pixel Canvas Tests"
                },
                "timestamp": "${{ github.event.workflow_run.updated_at }}"
              }]
            }